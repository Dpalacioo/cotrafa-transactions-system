<div class="mb-6">
  <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">
    {{ "USER_SELECTION.TITLE" | translate }}
  </h2>

  <div class="mb-4">
    <input
      type="text"
      placeholder="{{ 'USER_SELECTION.SEARCH_PLACEHOLDER' | translate }}"
      class="w-full md:w-1/2 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
      (input)="onSearch($event)"
    />
  </div>

  <div
    *ngIf="filteredUsers.length === 0"
    class="py-8 text-center text-gray-900 dark:text-gray-100"
  >
    {{ "USER_SELECTION.NO_RESULTS" | translate }}
  </div>

  <mat-accordion
    *ngIf="paginatedUsers.length > 0"
    class="overflow-x-auto lg:overflow-x-visible"
  >
    <div
      class="min-w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-t-lg shadow table-fixed"
    >
      <div class="bg-gray-50 dark:bg-gray-800 flex">
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-2/5"
        >
          {{ "USER_SELECTION.TABLE_HEADERS.USER" | translate }}
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          {{ "USER_SELECTION.TABLE_HEADERS.EMAIL" | translate }}
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          {{ "USER_SELECTION.TABLE_HEADERS.LOCATION" | translate }}
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          {{ "USER_SELECTION.TABLE_HEADERS.PHONE" | translate }}
        </div>
      </div>
    </div>

    <mat-expansion-panel
      *ngFor="let user of paginatedUsers; trackBy: trackByUserId"
      hideToggle
      class="!rounded-none !shadow-none border-t border-gray-200 dark:border-gray-700 !bg-white dark:!bg-gray-900"
      [class.border-primary]="selectedUserId === user.id"
      [class.ring-2]="selectedUserId === user.id"
      [class.ring-primary]="selectedUserId === user.id"
    >
      <mat-expansion-panel-header
        class="!p-0 !h-auto !min-h-0 hover:!bg-gray-50 dark:hover:!bg-gray-800 !bg-transparent"
        (click)="selectUser(user.id); $event.stopPropagation()"
      >
        <div class="flex w-full cursor-pointer">
          <div class="py-1 px-4 w-2/5 flex items-center">
            <img
              *ngIf="user.picture"
              [src]="user.picture"
              alt="{{ user.name }}"
              class="w-8 h-8 rounded-full mr-4 flex-shrink-0"
            />
            <div class="flex-1 min-w-0">
              <p class="font-medium truncate text-gray-900 dark:text-gray-100">
                {{ user.name }}
              </p>
            </div>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.email }}
            </p>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.city }}, {{ user.country }}
            </p>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.phone }}
            </p>
          </div>
        </div>
      </mat-expansion-panel-header>

      <div
        class="border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
      >
        <div
          *ngIf="selectedUserId === user.id"
          class="rounded-lg shadow p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 mt-2"
        >
          <app-transaction-form
            *ngIf="shouldShowForm(user.id)"
            (submitTransaction)="onTransactionSubmit($event, user.id)"
          ></app-transaction-form>

          <app-transaction-result
            *ngIf="getUserLastCus(user.id) && !shouldShowForm(user.id)"
            [encryptedCus]="getUserLastCus(user.id)!.encrypted"
            [originalCus]="getUserLastCus(user.id)!.original"
          ></app-transaction-result>

          <div
            *ngIf="shouldShowNewTransactionButton(user.id)"
            class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"
          >
            <button
              (click)="startNewTransaction(user.id)"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
            >
              {{ "USER_SELECTION.TRANSACTION.NEW" | translate }}
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>

  <div
    *ngIf="totalPages > 1 && filteredUsers.length > 0"
    class="flex flex-col md:flex-row md:items-center md:justify-between mt-4"
  >
    <div
      class="mb-3 md:mb-0 text-gray-700 dark:text-gray-300 text-sm md:text-base text-center md:text-left"
    >
      {{ "USER_SELECTION.PAGINATION.SHOWING" | translate }}
      <span class="font-semibold">{{ (currentPage - 1) * pageSize + 1 }}</span>
      {{ "USER_SELECTION.PAGINATION.TO" | translate }}
      <span class="font-semibold">{{
        (currentPage - 1) * pageSize + paginatedUsers.length
      }}</span>
      {{ "USER_SELECTION.PAGINATION.OF" | translate }}
      <span class="font-semibold">{{ filteredUsers.length }}</span>
      {{ "USER_SELECTION.PAGINATION.RESULTS" | translate }}
    </div>
    <div class="w-full md:w-auto">
      <!-- Versión para desktop -->
      <nav class="hidden md:inline-flex -space-x-px" aria-label="Pagination">
        <button
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
          class="px-3 py-1 rounded-l-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
        >
          {{ "USER_SELECTION.PAGINATION.PREVIOUS" | translate }}
        </button>

        <button
          *ngFor="let page of pages"
          (click)="goToPage(page)"
          class="px-3 py-1 border transition"
          [ngClass]="{
            'bg-primary text-gray-900 dark:text-gray-100 border-gray-400 dark:border-gray-500': currentPage === page,
            'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700': currentPage !== page && typeof page === 'number',
            'bg-transparent border-transparent text-gray-500 dark:text-gray-400 cursor-default': page === '...'
          }"
          [disabled]="page === '...'"
        >
          {{ page }}
        </button>

        <button
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === totalPages"
          class="px-3 py-1 rounded-r-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
        >
          {{ "USER_SELECTION.PAGINATION.NEXT" | translate }}
        </button>
      </nav>

      <!-- Versión para móvil -->
      <nav
        class="md:hidden flex items-center justify-center space-x-2"
        aria-label="Pagination"
      >
        <button
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
          class="px-3 py-1.5 rounded-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 flex items-center text-sm"
          [attr.aria-label]="
            'USER_SELECTION.PAGINATION.PREVIOUS_ARIA' | translate
          "
        >
          <svg
            class="w-4 h-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          {{ "USER_SELECTION.PAGINATION.PREVIOUS" | translate }}
        </button>

        <div
          class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 rounded-lg"
        >
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
            {{ currentPage }}
            <span class="text-gray-500">/{{ totalPages }}</span>
          </span>
        </div>

        <button
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === totalPages"
          class="px-3 py-1.5 rounded-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 flex items-center text-sm"
          [attr.aria-label]="'USER_SELECTION.PAGINATION.NEXT_ARIA' | translate"
        >
          {{ "USER_SELECTION.PAGINATION.NEXT" | translate }}
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>
      </nav>
    </div>
  </div>
  <div
    *ngIf="toastMessage"
    class="fixed bottom-4 right-4 bg-green-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm animate-fade-in z-50"
  >
    {{ "USER_SELECTION.TOAST.SUCCESS" | translate }}
  </div>
</div>
