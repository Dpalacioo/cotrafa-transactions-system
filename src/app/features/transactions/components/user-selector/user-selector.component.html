<div class="mb-6">
  <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">
    Seleccionar usuario
  </h2>

  <div class="mb-4">
    <input
      type="text"
      placeholder="Buscar usuario por nombre, email o ciudad."
      class="w-full md:w-1/2 px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
      (input)="onSearch($event)"
    />
  </div>

  <div
    *ngIf="filteredUsers.length === 0"
    class="py-8 text-center text-gray-900 dark:text-gray-100"
  >
    No hay resultados para la búsqueda actual
  </div>

  <mat-accordion
    *ngIf="paginatedUsers.length > 0"
    class="overflow-x-auto lg:overflow-x-visible"
  >
    <div
      class="min-w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-t-lg shadow table-fixed"
    >
      <div class="bg-gray-50 dark:bg-gray-800 flex">
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-2/5"
        >
          Usuario
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          Email
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          Ubicación
        </div>
        <div
          class="py-3 px-4 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-1/5"
        >
          Teléfono
        </div>
      </div>
    </div>

    <mat-expansion-panel
      *ngFor="let user of paginatedUsers; trackBy: trackByUserId"
      hideToggle
      class="!rounded-none !shadow-none border-t border-gray-200 dark:border-gray-700 !bg-white dark:!bg-gray-900"
      [class.border-primary]="selectedUserId === user.id"
      [class.ring-2]="selectedUserId === user.id"
      [class.ring-primary]="selectedUserId === user.id"
    >
      <mat-expansion-panel-header
        class="!p-0 !h-auto !min-h-0 hover:!bg-gray-50 dark:hover:!bg-gray-800 !bg-transparent"
        (click)="selectUser(user.id); $event.stopPropagation()"
      >
        <div class="flex w-full cursor-pointer">
          <div class="py-1 px-4 w-2/5 flex items-center">
            <img
              *ngIf="user.picture"
              [src]="user.picture"
              alt="{{ user.name }}"
              class="w-8 h-8 rounded-full mr-4 flex-shrink-0"
            />
            <div class="flex-1 min-w-0">
              <p class="font-medium truncate text-gray-900 dark:text-gray-100">
                {{ user.name }}
              </p>
            </div>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.email }}
            </p>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.city }}, {{ user.country }}
            </p>
          </div>

          <div class="py-4 px-4 w-1/5 flex items-center">
            <p class="text-sm truncate text-gray-600 dark:text-gray-400">
              {{ user.phone }}
            </p>
          </div>
        </div>
      </mat-expansion-panel-header>

      <div
        class="border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"
      >
        <div
          *ngIf="selectedUserId === user.id"
          class="rounded-lg shadow p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 mt-2"
        >
          <!-- Formulario solo visible si NO hay transacción reciente Y el usuario lo activó -->
          <app-transaction-form
            *ngIf="shouldShowForm(user.id)"
            (submitTransaction)="onTransactionSubmit($event, user.id)"
          ></app-transaction-form>

          <!-- Resultado solo visible SI hay transacción reciente -->
          <app-transaction-result
            *ngIf="getUserLastCus(user.id) && !shouldShowForm(user.id)"
            [encryptedCus]="getUserLastCus(user.id)!.encrypted"
            [originalCus]="getUserLastCus(user.id)!.original"
          ></app-transaction-result>

          <!-- Botón para nueva transacción (solo visible cuando hay resultado y no se está mostrando el formulario) -->
          <div
            *ngIf="shouldShowNewTransactionButton(user.id)"
            class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"
          >
            <button
              (click)="startNewTransaction(user.id)"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
            >
              Nueva transacción
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>

  <div
    *ngIf="totalPages > 1 && filteredUsers.length > 0"
    class="flex flex-col md:flex-row md:items-center md:justify-between mt-4"
  >
    <div class="mb-2 md:mb-0 text-gray-700 dark:text-gray-300">
      Mostrando
      {{ (currentPage - 1) * pageSize + 1 }}
      a
      {{ (currentPage - 1) * pageSize + paginatedUsers.length }}
      de {{ users.length }} resultados
    </div>

    <nav class="inline-flex -space-x-px" aria-label="Pagination">
      <button
        (click)="goToPage(currentPage - 1)"
        [disabled]="currentPage === 1"
        class="px-3 py-1 rounded-l-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
      >
        Anterior
      </button>

      <button
        *ngFor="let page of pages"
        (click)="goToPage(page)"
        class="px-3 py-1 border transition"
        [ngClass]="{
          'bg-primary text-gray-900 dark:text-gray-100 border-gray-400 dark:border-gray-500':
            currentPage === page,
          'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700':
            currentPage !== page
        }"
      >
        {{ page }}
      </button>

      <button
        (click)="goToPage(currentPage + 1)"
        [disabled]="currentPage === totalPages"
        class="px-3 py-1 rounded-r-lg border bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"
      >
        Siguiente
      </button>
    </nav>
  </div>
  <div
    *ngIf="toastMessage"
    class="fixed bottom-4 right-4 bg-green-900 text-white px-4 py-2 rounded-lg shadow-lg text-sm animate-fade-in z-50"
  >
    {{ toastMessage }}
  </div>
</div>
